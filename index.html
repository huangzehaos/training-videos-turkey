<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title> Eğitim Videosu </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; background: #f5f5f5; }
    .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 10px; }
    h1 { color: #333; }
    button { padding: 12px 24px; font-size: 18px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
    .warning { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1> Eğitim Videosu </h1>
    <p>Lütfen aşağıdaki videoyu tamamen izleyin. İzleme kaydı otomatik olarak tutulacaktır.</p>
    
    <div id="video-container" style="display:none;">
      <iframe 
        id="youtube-player"
        width="100%" 
        height="400" 
        src="https://www.youtube.com/embed/KjfqUJd0FZs?enablejsapi=1&autoplay=0" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen>
      </iframe>
    </div>

    <button onclick="startVideo()">Videoyu İzlemeye Başla</button>
    <p class="warning" id="status">İzleme durumu: Bekleniyor...</p>
  </div>

  <script>
    let userId = null;
    const videoId = "KjfqUJd0FZs"; // 替换为你的YouTube视频ID

    // 从 URL 获取用户ID（通过 Google Form 链接传入）
    const urlParams = new URLSearchParams(window.location.search);
    userId = urlParams.get('user_id');
    
    if (!userId) {
      alert("Lütfen eğitim linkini resmi gönderilen bağlantıdan kullanın.");
      window.location.href = "https://docs.google.com/forms/d/e/1FAIpQLSdAogVWO_-mIe3x_EFjl3quY4bhDSnRaxfRPpWnFLsamwHFFg/viewform?embedded=true"; // 替换为你的表单链接
    }

    function startVideo() {
      document.getElementById('video-container').style.display = 'block';
      document.querySelector('button').disabled = true;
      document.getElementById('status').innerText = "İzleme başlatıldı... Tamamlanırsa otomatik kaydedilecektir.";

      // 加载 YouTube API
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);

      window.onYouTubeIframeAPIReady = function() {
        player = new YT.Player('youtube-player', {
          events: {
            'onStateChange': onPlayerStateChange
          }
        });
      };
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        // 完成播放
        fetch(`https://script.google.com/macros/s/AKfycbyXfMNVp38wwRA6Kz0rnzyrg3vrzyzmT-WnyvvBGiEKYqIfkHtu9ysO6ugo6oAtH5vC7Q/exec?action=complete&user_id=${userId}`, { method: 'GET' });
        document.getElementById('status').innerText = "Tebrikler! Eğitim tamamlandı.";
        document.getElementById('status').style.color = 'green';
      } else if (event.data === YT.PlayerState.PLAYING) {
        // 开始播放，监听快进
        setInterval(() => {
          if (player && player.getCurrentTime) {
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            const progress = currentTime / duration;

            // 如果进度跳变 > 10%（疑似快进），记录
            if (progress > 0.1 && progress < 0.9) {
              // 每5秒检查一次，如果跳变大，记录
              // 本例简化：只要播放超过10%就认为“可能未完整观看”
              // 更精准需记录前一时间点做差值，但免费方案中可简化处理
            }
          }
        }, 5000);
      }
    }
  </script>
</body>

</html>
